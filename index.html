<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡æ•°æ®å¯¼å…¥ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>æ‰¹é‡æ•°æ®å¯¼å…¥ç³»ç»Ÿ</h1>
        
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" multiple>
                <div class="upload-text">
                    <i class="upload-icon">ğŸ“</i>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
                    <p class="upload-hint">æ”¯æŒ CSVã€Excel æ–‡ä»¶æ ¼å¼</p>
                </div>
            </div>
            <button class="btn btn-primary" id="uploadBtn">å¼€å§‹å¯¼å…¥</button>
        </div>

        <!-- è¿›åº¦æç¤º -->
        <div class="progress-section" id="progressSection" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">æ­£åœ¨å¤„ç†...</p>
        </div>

        <!-- ç»“æœè¡¨æ ¼ -->
        <div class="table-section">
            <div class="table-header">
                <h2>å¯¼å…¥ç»“æœ</h2>
                <div class="table-actions">
                    <button class="btn btn-secondary" id="clearBtn">æ¸…ç©ºè®°å½•</button>
                    <button class="btn btn-success" id="exportBtn">å¯¼å‡ºç»“æœ</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>æ–‡ä»¶å</th>
                            <th>çŠ¶æ€</th>
                            <th>å¤„ç†æ—¶é—´</th>
                            <th>æˆåŠŸè®°å½•</th>
                            <th>å¤±è´¥è®°å½•</th>
                            <th>é”™è¯¯ä¿¡æ¯</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody">
                        <!-- åŠ¨æ€æ·»åŠ çš„ç»“æœè¡Œ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-section">
            <div class="stat-card">
                <h3>æ€»æ–‡ä»¶æ•°</h3>
                <span id="totalFiles">0</span>
            </div>
            <div class="stat-card success">
                <h3>æˆåŠŸå¯¼å…¥</h3>
                <span id="successCount">0</span>
            </div>
            <div class="stat-card error">
                <h3>å¤±è´¥å¯¼å…¥</h3>
                <span id="errorCount">0</span>
            </div>
            <div class="stat-card">
                <h3>æ€»è®°å½•æ•°</h3>
                <span id="totalRecords">0</span>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h2>è¯¦ç»†ä¿¡æ¯</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        class DataImportManager {
            constructor() {
                this.fileInput = document.getElementById('fileInput');
                this.uploadArea = document.getElementById('uploadArea');
                this.uploadBtn = document.getElementById('uploadBtn');
                this.progressSection = document.getElementById('progressSection');
                this.progressFill = document.getElementById('progressFill');
                this.progressText = document.getElementById('progressText');
                this.resultTableBody = document.getElementById('resultTableBody');
                this.clearBtn = document.getElementById('clearBtn');
                this.exportBtn = document.getElementById('exportBtn');
                this.detailModal = document.getElementById('detailModal');
                this.closeModal = document.getElementById('closeModal');
                this.modalBody = document.getElementById('modalBody');
                
                this.files = [];
                this.results = [];
                this.currentIndex = 0;
                
                this.initEventListeners();
            }

            initEventListeners() {
                // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
                this.fileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files);
                });

                // æ‹–æ‹½ä¸Šä¼ 
                this.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.add('drag-over');
                });

                this.uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.remove('drag-over');
                });

                this.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.remove('drag-over');
                    this.handleFileSelect(e.dataTransfer.files);
                });

                // ä¸Šä¼ æŒ‰é’®
                this.uploadBtn.addEventListener('click', () => {
                    this.startImport();
                });

                // æ¸…ç©ºæŒ‰é’®
                this.clearBtn.addEventListener('click', () => {
                    this.clearResults();
                });

                // å¯¼å‡ºæŒ‰é’®
                this.exportBtn.addEventListener('click', () => {
                    this.exportResults();
                });

                // æ¨¡æ€æ¡†å…³é—­
                this.closeModal.addEventListener('click', () => {
                    this.detailModal.style.display = 'none';
                });

                window.addEventListener('click', (e) => {
                    if (e.target === this.detailModal) {
                        this.detailModal.style.display = 'none';
                    }
                });
            }

            handleFileSelect(files) {
                this.files = Array.from(files);
                this.updateUploadAreaText();
                this.uploadBtn.disabled = this.files.length === 0;
            }

            updateUploadAreaText() {
                const uploadText = this.uploadArea.querySelector('.upload-text p');
                if (this.files.length > 0) {
                    uploadText.textContent = `å·²é€‰æ‹© ${this.files.length} ä¸ªæ–‡ä»¶`;
                } else {
                    uploadText.textContent = 'ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ ';
                }
            }

            async startImport() {
                if (this.files.length === 0) {
                    alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                    return;
                }

                this.uploadBtn.disabled = true;
                this.progressSection.style.display = 'block';
                this.currentIndex = 0;

                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    await this.processFile(file, i);
                    this.updateProgress(i + 1, this.files.length);
                }

                this.uploadBtn.disabled = false;
                this.progressSection.style.display = 'none';
                this.updateStatistics();
            }

            async processFile(file, index) {
                const startTime = new Date();
                
                try {
                    // æ¨¡æ‹Ÿæ–‡ä»¶å¤„ç†ï¼ˆè¿™é‡Œåº”è¯¥æ›¿æ¢ä¸ºå®é™…çš„æœåŠ¡å™¨è¯·æ±‚ï¼‰
                    const result = await this.simulateFileProcessing(file);
                    
                    const endTime = new Date();
                    const processingTime = endTime - startTime;
                    
                    const resultData = {
                        index: index + 1,
                        filename: file.name,
                        status: result.success ? 'success' : 'error',
                        processingTime: `${processingTime}ms`,
                        successCount: result.successCount,
                        errorCount: result.errorCount,
                        errorMessage: result.errorMessage || '',
                        details: result.details || []
                    };
                    
                    this.results.push(resultData);
                    this.addResultRow(resultData);
                    
                } catch (error) {
                    const endTime = new Date();
                    const processingTime = endTime - startTime;
                    
                    const resultData = {
                        index: index + 1,
                        filename: file.name,
                        status: 'error',
                        processingTime: `${processingTime}ms`,
                        successCount: 0,
                        errorCount: 1,
                        errorMessage: error.message,
                        details: []
                    };
                    
                    this.results.push(resultData);
                    this.addResultRow(resultData);
                }
            }

            async simulateFileProcessing(file) {
                // æ¨¡æ‹Ÿå¼‚æ­¥å¤„ç†
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // æ¨¡æ‹Ÿå¤„ç†ç»“æœ
                        const isSuccess = Math.random() > 0.3; // 70%æˆåŠŸç‡
                        const recordCount = Math.floor(Math.random() * 100) + 10;
                        
                        if (isSuccess) {
                            const successCount = Math.floor(recordCount * 0.9);
                            const errorCount = recordCount - successCount;
                            
                            resolve({
                                success: true,
                                successCount,
                                errorCount,
                                details: Array.from({length: recordCount}, (_, i) => ({
                                    row: i + 1,
                                    status: i < successCount ? 'success' : 'error',
                                    data: `è®°å½• ${i + 1}`
                                }))
                            });
                        } else {
                            resolve({
                                success: false,
                                successCount: 0,
                                errorCount: 1,
                                errorMessage: 'æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒæˆ–å†…å®¹æœ‰è¯¯'
                            });
                        }
                    }, Math.random() * 2000 + 500); // 0.5-2.5ç§’éšæœºå»¶è¿Ÿ
                });
            }

            addResultRow(data) {
                const row = document.createElement('tr');
                row.className = data.status === 'success' ? 'success-row' : 'error-row';
                
                const statusIcon = data.status === 'success' ? 'âœ…' : 'âŒ';
                const statusText = data.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';
                
                row.innerHTML = `
                    <td>${data.index}</td>
                    <td>${data.filename}</td>
                    <td class="status-cell">
                        <span class="status-icon">${statusIcon}</span>
                        <span class="status-text">${statusText}</span>
                    </td>
                    <td>${data.processingTime}</td>
                    <td>${data.successCount}</td>
                    <td>${data.errorCount}</td>
                    <td class="error-message">${data.errorMessage}</td>
                    <td>
                        <button class="btn btn-detail" onclick="importManager.showDetails(${data.index - 1})">
                            è¯¦æƒ…
                        </button>
                    </td>
                `;
                
                this.resultTableBody.appendChild(row);
            }

            updateProgress(current, total) {
                const percentage = (current / total) * 100;
                this.progressFill.style.width = `${percentage}%`;
                this.progressText.textContent = `æ­£åœ¨å¤„ç†... ${current}/${total}`;
            }

            updateStatistics() {
                const totalFiles = this.results.length;
                const successCount = this.results.filter(r => r.status === 'success').length;
                const errorCount = this.results.filter(r => r.status === 'error').length;
                const totalRecords = this.results.reduce((sum, r) => sum + r.successCount + r.errorCount, 0);
                
                document.getElementById('totalFiles').textContent = totalFiles;
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('errorCount').textContent = errorCount;
                document.getElementById('totalRecords').textContent = totalRecords;
            }

            clearResults() {
                this.results = [];
                this.resultTableBody.innerHTML = '';
                this.updateStatistics();
            }

            exportResults() {
                if (this.results.length === 0) {
                    alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                    return;
                }

                const csvContent = this.convertToCSV(this.results);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `import_results_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            convertToCSV(data) {
                const headers = ['åºå·', 'æ–‡ä»¶å', 'çŠ¶æ€', 'å¤„ç†æ—¶é—´', 'æˆåŠŸè®°å½•', 'å¤±è´¥è®°å½•', 'é”™è¯¯ä¿¡æ¯'];
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => [
                        row.index,
                        `"${row.filename}"`,
                        row.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥',
                        row.processingTime,
                        row.successCount,
                        row.errorCount,
                        `"${row.errorMessage}"`
                    ].join(','))
                ].join('\n');
                
                return '\uFEFF' + csvContent; // æ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡
            }

            showDetails(index) {
                const result = this.results[index];
                if (!result) return;
                
                let detailsHTML = `
                    <h3>æ–‡ä»¶ï¼š${result.filename}</h3>
                    <p><strong>çŠ¶æ€ï¼š</strong>${result.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}</p>
                    <p><strong>å¤„ç†æ—¶é—´ï¼š</strong>${result.processingTime}</p>
                    <p><strong>æˆåŠŸè®°å½•ï¼š</strong>${result.successCount}</p>
                    <p><strong>å¤±è´¥è®°å½•ï¼š</strong>${result.errorCount}</p>
                `;
                
                if (result.errorMessage) {
                    detailsHTML += `<p><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>${result.errorMessage}</p>`;
                }
                
                if (result.details && result.details.length > 0) {
                    detailsHTML += '<h4>è¯¦ç»†è®°å½•ï¼š</h4>';
                    detailsHTML += '<div class="details-list">';
                    result.details.forEach(detail => {
                        const statusIcon = detail.status === 'success' ? 'âœ…' : 'âŒ';
                        detailsHTML += `<div class="detail-item ${detail.status}">
                            <span>${statusIcon}</span>
                            <span>ç¬¬${detail.row}è¡Œ: ${detail.data}</span>
                        </div>`;
                    });
                    detailsHTML += '</div>';
                }
                
                this.modalBody.innerHTML = detailsHTML;
                this.detailModal.style.display = 'block';
            }
        }

        // åˆå§‹åŒ–
        const importManager = new DataImportManager();
    </script>
</body>
</html>